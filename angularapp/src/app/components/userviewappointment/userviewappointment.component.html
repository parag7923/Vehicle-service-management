<div class="container-fluid mt-4">
  <h2 class="text-center mb-4">My Appointments</h2>
 
  <div class="filter-search-row">
    <div class="form-group">
      <label for="statusFilter">Filter by Status:</label>
      <select id="statusFilter" class="form-control" [(ngModel)]="selectedStatus" (change)="onFilterChange()">
        <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
      </select>
    </div>
  
    <div class="form-group">
      <label for="searchInput">Search:</label>
      <input type="text"
             id="searchInput"
             class="form-control search-input"
             placeholder="Search by service, location, status..."
             [(ngModel)]="searchTerm"
             (ngModelChange)="onFilterChange()">
    </div>
  </div>
  
  
 
  <div *ngIf="isLoading" class="alert alert-info" role="alert">
    Loading your appointments...
  </div>
 
  <div *ngIf="!isLoading && filteredAppointments.length === 0" class="alert alert-info" role="alert">
    You have no appointments.
  </div>
 
  <div *ngIf="!isLoading && filteredAppointments.length > 0" class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="thead-dark">
        <tr>
          <th>Service Name</th>
          <th>Vehicle Type</th>
          <th>Price</th>
          <th>Appointment Date</th>
          <th>Time Slot</th> <th>Location</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let app of paginatedAppointments">
          <td>
            <span *ngIf="app.service; else notAvailable" >
            {{ app.bookedServiceName }}</span>
            <ng-template #notAvailable> 
              <span style="color: rgb(245, 80, 80); font-style: italic;">Service Not Available</span>
            </ng-template>
          </td>
          <td>{{ app.bookedVehicleType  }}</td>
          <td>{{ app.bookedServicePrice | currency:'INR'}}</td>
          <td>{{ app.appointmentDate | date:'longDate' }}</td>
          <td>{{ app.timeSlot}}</td> <td>{{ app.location }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'badge-warning': app.status === 'Pending',
              'badge-success': app.status === 'Approved',
              'badge-danger': app.status === 'Rejected',
              'badge-secondary': app.status === 'Cancelled'
            }">
              {{ app.status }}
            </span>
          </td>
          
          <td>
            <button class="btn btn-primary btn-sm mr-2" 
                    (click)="openEditModal(app)" 
                    [disabled]="app.status !== 'Pending' || !app.service "
                    title="Edit">
              Edit
            </button>
            
            <button class="btn btn-danger btn-sm" 
                    (click)="openCancelConfirm(app)"
                    [disabled]="app.status === 'Rejected' || app.status === 'Cancelled'|| !app.service "
                    title="Cancel (Not allowed for 'Rejected' or 'Cancelled')">
              Cancel
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
 
  <nav *ngIf="!isLoading && totalPages > 1" aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage - 1)">Previous</a>
      </li>
      <li class="page-item" *ngFor="let page of totalPagesArray" [class.active]="page === currentPage">
        <a class="page-link" href="javascript:void(0)" (click)="changePage(page)">{{ page }}</a>
      </li>
      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <a class="page-link" href="javascript:void(0)" (click)="changePage(currentPage + 1)">Next</a>
      </li>
    </ul>
  </nav>
 
</div>
 
 
<div class="modal-backdrop" *ngIf="showEditModal"></div>
<div class="modal" *ngIf="showEditModal" tabindex="-1" style="display: block;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Appointment</h5>
        <button type="button" class="close" (click)="closeEditModal()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <form #editForm="ngForm" (ngSubmit)="onUpdateAppointment(editForm)">
          <div class="form-group">
            <label for="service">Service:</label>
            <input id="service" type="text" class="form-control" [value]="currentEditingAppointment?.service?.serviceName" readonly>
          </div>
          
          <div class="form-group">
            <label for="appointmentDate">Appointment Date</label>
            <input type="date" class="form-control" id="appointmentDate" name="appointmentDate"
                   [(ngModel)]="editFormData.appointmentDate"
                   [min]="today"
                   required
                   (change)="onEditDateChange()" #dateInput="ngModel">
            <div *ngIf="dateInput.invalid && dateInput.touched" class="invalid-feedback d-block">
              <span *ngIf="dateInput.errors?.required">Date is required.</span>
            </div>
          </div>
 
          <div class="form-group">
            <label>Available Time Slots</label>
            
            <div *ngIf="editIsLoadingSlots" class="text-center">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <span class_="ml-2">Loading slots...</span>
            </div>
 
            <div *ngIf="!editIsLoadingSlots && editAvailableSlots.length > 0" class="slot-container">
              <button
                type="button"
                *ngFor="let slot of editAvailableSlots"
                class="btn slot-btn"
                [class.btn-primary]="slot === editFormData.timeSlot"
                [class.btn-outline-primary]="slot !== editFormData.timeSlot"
                (click)="selectEditSlot(slot)"
              >
                {{ slot }}
              </button>
            </div>
            
            <input type="hidden" name="timeSlot" [(ngModel)]="editFormData.timeSlot" required>
          </div>
 
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" class="form-control" id="location" name="location"
                   [(ngModel)]="editFormData.location"
                   required
                   minlength="3"
                   [pattern]="LOCATION_REGEX.source"
                   #locationInput="ngModel">
            <div *ngIf="locationInput.invalid && locationInput.touched" class="invalid-feedback d-block">
              <span *ngIf="locationInput.errors?.required">Location is required.</span>
              <span *ngIf="locationInput.errors?.minlength">Location must be at least 3 characters</span>
              <span *ngIf="locationInput.errors?.pattern">Location can only contain letters and spaces.</span>
            </div>
          </div>
 
          <div *ngIf="editErrorMessage" class="alert alert-danger mt-3">
            {{ editErrorMessage }}
          </div>
 
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Close</button>
            <button type="submit" class="btn btn-primary" 
                    [disabled]="editForm.invalid || !editFormData.timeSlot || isProcessing">
              {{ isProcessing ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>
        </form>
        
      </div>
    </div>
  </div>
</div>
 
 
<div class="modal-backdrop" *ngIf="showCancelConfirm"></div>
<div class="modal" *ngIf="showCancelConfirm" tabindex="-1" style="display: block;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Cancellation</h5>
        <button type="button" class="close" (click)="closeCancelConfirm()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to cancel your appointment for 
           <strong>{{ appointmentToCancel?.service?.serviceName }}</strong> on 
           <strong>{{ appointmentToCancel?.appointmentDate | date:'longDate' }}</strong> at
           <strong>{{ appointmentToCancel?.timeSlot }}</strong>?
        </p>
        <p *ngIf="appointmentToCancel?.status === 'Approved'" class="text-warning font-weight-bold">
          This appointment has already been approved.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCancelConfirm()" [disabled]="isProcessing">
          No, Keep It
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmCancel()" [disabled]="isProcessing">
          {{ isProcessing ? 'Cancelling...' : 'Yes, Cancel Appointment' }}
        </button>
      </div>
    </div>
  </div>
</div>
 
 
<div class="popup success-popup" *ngIf="showSuccessPopup">
  {{ successMessage }}
  <button class="close-popup" (click)="closeSuccessPopup()">&times;</button>
</div>
 
<div class="popup error-popup" *ngIf="showErrorPopup">
  {{ errorMessage }}
  <button class="close-popup" (click)="closeErrorPopup()">&times;</button>
</div>
